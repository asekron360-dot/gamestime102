<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Cleanâ€¯Masterâ€¯Privacy</title>
<link rel="icon" href="https://proton.me/favicon.ico">
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:0;}
  header{background:#0b0d0e;color:#fff;padding:1rem;text-align:center;}
  main{max-width:900px;margin:auto;padding:1rem;}
  .card{background:#fff;border-radius:8px;padding:1.5rem;margin-bottom:1rem;box-shadow:0 2px 4px rgba(0,0,0,.1);}
  button{background:#0068ff;color:#fff;border:none;padding:.6rem 1.2rem;border-radius:4px;cursor:pointer;}
  button:disabled{opacity:.6;cursor:not-allowed;}
  input[type=file]{margin-top:.5rem;}
  table{width:100%;border-collapse:collapse;margin-top:.5rem;}
  th,td{padding:.5rem;border-bottom:1px solid #ddd;text-align:left;}
  .log{font-size:.85rem;color:#555;white-space:pre-wrap;background:#eee;padding:.5rem;border-radius:4px;}
  #lang-select{position:absolute;top:1rem;right:1rem;}
</style>
</head>
<body>
<header>
  <h1 id="title">Cleanâ€¯Masterâ€¯Privacy</h1>
  <select id="lang-select">
    <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
    <option value="en">ğŸ‡¬ğŸ‡§ English</option>
  </select>
</header>

<main>

<div class="card" id="login-card">
  <h2 id="login-title">ğŸ” Protonâ€¯Mail ile GiriÅŸ Yap</h2>
  <p id="login-desc">UygulamayÄ± kullanabilmek iÃ§in Protonâ€¯Mail hesabÄ±nÄ±zla kimlik doÄŸrulamasÄ± yapmanÄ±z gerekir.</p>
  <button id="login-btn">Protonâ€¯Mail ile GiriÅŸ</button>
</div>

<div class="card" id="app-card" style="display:none;">
  <h2 id="app-title">ğŸ“‚ Dosya YÃ¼kle & Tarama</h2>
  <input type="file" id="file-input" accept="*/*"><br>
  <button id="scan-btn" disabled>ğŸ›¡ï¸ DosyayÄ± Tara & YÃ¼kle</button>
  <div id="progress" style="margin-top:1rem;"></div>
  <h3 id="history-title">GeÃ§miÅŸ Ä°ÅŸlemler</h3>
  <table id="history-table">
    <thead><tr><th id="th-time">Zaman</th><th id="th-file">Dosya</th><th id="th-status">Durum</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

</main>

<script>
// ==================== CONFIG ====================
const LANG = {
  tr:{
    title:"Cleanâ€¯Masterâ€¯Privacy",
    loginTitle:"ğŸ” Protonâ€¯Mail ile GiriÅŸ Yap",
    loginDesc:"UygulamayÄ± kullanabilmek iÃ§in Protonâ€¯Mail hesabÄ±nÄ±zla kimlik doÄŸrulamasÄ± yapmanÄ±z gerekir.",
    loginBtn:"Protonâ€¯Mail ile GiriÅŸ",
    appTitle:"ğŸ“‚ Dosya YÃ¼kle & Tarama",
    scanBtn:"ğŸ›¡ï¸ DosyayÄ± Tara & YÃ¼kle",
    history:"GeÃ§miÅŸ Ä°ÅŸlemler",
    thTime:"Zaman",
    thFile:"Dosya",
    thStatus:"Durum",
    statusClean:"Temiz",
    statusInfected:"ZararlÄ±",
    statusError:"Hata",
    progressScanning:"Tarama yapÄ±lÄ±yorâ€¦",
    progressEncrypting:"Åifreleniyorâ€¦",
    progressUploading:"Protonâ€¯Driveâ€™a yÃ¼kleniyorâ€¦",
    done:"TamamlandÄ±"
  },
  en:{
    title:"Cleanâ€¯Masterâ€¯Privacy",
    loginTitle:"ğŸ” Sign In with Protonâ€¯Mail",
    loginDesc:"You must authenticate with your Protonâ€¯Mail account to use the app.",
    loginBtn:"Sign in with Protonâ€¯Mail",
    appTitle:"ğŸ“‚ Upload & Scan File",
    scanBtn:"ğŸ›¡ï¸ Scan & Upload",
    history:"History",
    thTime:"Time",
    thFile:"File",
    thStatus:"Status",
    statusClean:"Clean",
    statusInfected:"Infected",
    statusError:"Error",
    progressScanning:"Scanningâ€¦",
    progressEncrypting:"Encryptingâ€¦",
    progressUploading:"Uploading to Protonâ€¯Driveâ€¦",
    done:"Done"
  }
};

const PROTON_CLIENT_ID   = "YOUR_PROTON_CLIENT_ID"; // â† buraya kendi clientâ€‘IDâ€™nizi koyun
const REDIRECT_URI      = location.origin + location.pathname;
const PROTON_OAUTH_URL  = "https://account.proton.me/oauth/v4/authorize";
const PROTON_DRIVE_API  = "https://drive.proton.me/api/v2";
const SCAN_SIGNATURES   = [
  {hex:"4D5A",desc:"Windows EXE"},
  {hex:"504B0304",desc:"ZIP/Office"}
];

// ==================== STATE ====================
let curLang = "tr";
let eccKeyPair = null;

// ==================== UI HELPERS ====================
function $(sel){return document.querySelector(sel);}
function setText(id,text){$(id).textContent=text;}
function applyLang(){
  const t = LANG[curLang];
  setText("#title",t.title);
  setText("#login-title",t.loginTitle);
  setText("#login-desc",t.loginDesc);
  setText("#login-btn",t.loginBtn);
  setText("#app-title",t.appTitle);
  setText("#scan-btn",t.scanBtn);
  setText("#history-title",t.history);
  setText("#th-time",t.thTime);
  setText("#th-file",t.thFile);
  setText("#th-status",t.thStatus);
}
$("#lang-select").addEventListener("change",e=>{
  curLang=e.target.value;
  applyLang();
});
applyLang();

// ==================== OAUTH ====================
function buildAuthUrl(){
  const params = new URLSearchParams({
    client_id: PROTON_CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    response_type: "token",
    scope: "openid email drive",
    state: Math.random().toString(36).substring(2)
  });
  return `${PROTON_OAUTH_URL}?${params}`;
}
function parseHash(){
  const hash = location.hash.substring(1);
  const data = Object.fromEntries(new URLSearchParams(hash));
  return data.access_token;
}
function saveToken(t){localStorage.setItem("proton_access_token",t);}
function getToken(){return localStorage.getItem("proton_access_token");}
function clearToken(){localStorage.removeItem("proton_access_token");}

// -------------------- Login Flow --------------------
$("#login-btn").onclick = ()=>{
  location.href = buildAuthUrl();
};
window.addEventListener("load",()=>{
  const token = parseHash();
  if(token){
    saveToken(token);
    location.hash="";
  }
  if(getToken()){
    $("#login-card").style.display="none";
    $("#app-card").style.display="block";
    initApp();
  }
});

// ==================== ECC / Crypto ====================
async function generateECC(){
  eccKeyPair = await crypto.subtle.generateKey(
    {name:"ECDH",namedCurve:"P-256"},
    true,
    ["deriveKey"]
  );
  const spki = await crypto.subtle.exportKey("spki",eccKeyPair.publicKey);
  localStorage.setItem("ecc_pub",btoa(String.fromCharCode(...new Uint8Array(spki))));
}
async function loadECC(){
  // For demo we always generate a fresh pair per session.
  await generateECC();
}
await loadECC();

// -------------------- Simple AV --------------------
function hexToBytes(hex){
  const bytes=[];
  for(let i=0;i<hex.length;i+=2) bytes.push(parseInt(hex.substr(i,2),16));
  return new Uint8Array(bytes);
}
function matchesSignature(buf){
  for(const s of SCAN_SIGNATURES){
    const sig = hexToBytes(s.hex);
    let match=true;
    for(let i=0;i<sig.length;i++){
      if(buf[i]!==sig[i]){match=false;break;}
    }
    if(match) return s.desc;
  }
  return null;
}

// ==================== ENCRYPTION ====================
async function encryptFile(file){
  const buf = await file.arrayBuffer();

  // AESâ€‘GCM
  const aesKey = await crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt"]);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:"AES-GCM",iv},aesKey,buf);

  // Export AES key
  const rawAes = await crypto.subtle.exportKey("raw",aesKey);

  // Derive wrapping key from ECC shared secret (ECIESâ€‘like)
  const shared = await crypto.subtle.deriveBits(
    {name:"ECDH",public:eccKeyPair.publicKey},
    eccKeyPair.privateKey,
    256
  );
  const hkdfKey = await crypto.subtle.importKey(
    "raw",shared,{name:"HKDF"},false,["deriveKey"]
  );
  const wrapKey = await crypto.subtle.deriveKey(
    {name:"HKDF",hash:"SHA-256",salt:new Uint8Array([]),info:new Uint8Array([])},
    hkdfKey,{name:"AES-KW",length:256},false,["wrapKey"]
  );
  const wrappedAes = await crypto.subtle.wrapKey("raw",aesKey,wrapKey,{name:"AES-KW"});

  const payload = {
    iv:btoa(String.fromCharCode(...iv)),
    data:btoa(String.fromCharCode(...new Uint8Array(ct))),
    wrappedKey:btoa(String.fromCharCode(...new Uint8Array(wrappedAes))),
    pubKey:localStorage.getItem("ecc_pub")
  };
  const blob = new Blob([JSON.stringify(payload)],{type:"application/json"});
  return new File([blob], file.name+".enc", {type:"application/json"});
}

// ==================== HISTORY (IndexedDB) ====================
const DB_NAME = "clean_master_history";
const STORE = "records";

function openDb(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=()=>req.result.createObjectStore(STORE,{autoIncrement:true});
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function addRecord(rec){
  const db=await openDb();
  const tx=db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).add(rec);
  await tx.complete;
}
async function loadHistory(){
  const db=await openDb();
  const tx=db.transaction(STORE,"readonly");
  const all=await tx.objectStore(STORE).getAll();
  await tx.complete;
  return all;
}
function renderHistory(){
  loadHistory().then(list=>{
    const tbody=$("#history-table tbody");
    tbody.innerHTML="";
    list.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.time}</td><td>${r.file}</td><td>${r.status}</td>`;
      tbody.appendChild(tr);
    });
  });
}

// ==================== MAIN APP LOGIC ====================
function initApp(){
  $("#file-input").onchange=()=>{$("#scan-btn").disabled=!$("#file-input").files.length;};

  $("#scan-btn").onclick=async ()=>{
    const file = $("#file-input").files[0];
    if(!file) return;
    const t = LANG[curLang];

    // 1ï¸âƒ£ AV Scan
    $("#progress").textContent=t.progressScanning;
    const arr = new Uint8Array(await file.arrayBuffer());
    const sig = matchesSignature(arr);
    if(sig){
      const status=`${t.statusInfected} (${sig})`;
      await addRecord({time:now(),file:file.name,status});
      $("#progress").textContent=`${t.statusInfected}: ${sig}`;
      renderHistory();
      return;
    }

    // 2ï¸âƒ£ Encrypt
    $("#progress").textContent=t.progressEncrypting;
    const encFile = await encryptFile(file);

    // 3ï¸âƒ£ Upload to Proton Drive
    $("#progress").textContent=t.progressUploading;
    const token = getToken();
    const form = new FormData();
    form.append("file", encFile);
    try{
      const resp = await fetch(`${PROTON_DRIVE_API}/files`,{
        method:"POST",
        headers:{Authorization:`Bearer ${token}`},
        body:form
      });
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      await addRecord({time:now(),file:file.name,status:t.done});
      $("#progress").textContent=t.done;
    }catch(e){
      const errMsg=`${t.statusError}: ${e.message}`;
      await addRecord({time:now(),file:file.name,status:errMsg});
      $("#progress").textContent=errMsg;
    }
    renderHistory();
  };

  renderHistory();
}
</script>
</body>
</html>
