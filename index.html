<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Clean Master Privacy â€“ Tek SayfalÄ±k AntivirÃ¼s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- CSP â€“ GitHub Pages + CDN -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://code.jquery.com; img-src 'self' data:;">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous">
<style>
:root{--primary:#6c5ce7;--secondary:#a29bfe;--dark:#2d3436;--light:#dfe6e9;}
[data-theme="dark"]{--primary:#a29bfe;--secondary:#6c5ce7;--dark:#dfe6e9;--light:#2d3436;}
body{font-family:Arial,sans-serif;background:#f5f5f5;color:var(--dark);}
.navbar{background:#333;}
.page-section{display:none;padding:2rem;}
.page-section.active{display:block;}
.file-drop{border:2px dashed #bbb;padding:2rem;text-align:center;cursor:pointer;}
.file-drop.dragover{border-color:var(--primary);background:#fafafa;}
.toast{position:fixed;top:1rem;right:1rem;min-width:250px;}
</style>
</head>
<body data-theme="light">

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="fas fa-shield-alt"></i> Clean Master Privacy</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navMenu"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" href="#" data-page="home">Ana Sayfa</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-page="scan">Tarama</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-page="settings">Ayarlar</a></li>
      </ul>
      <button class="btn btn-outline-light" id="themeToggle"><i class="fas fa-moon"></i></button>
    </div>
  </div>
</nav>

<div class="container my-4">

  <!-- ==== HOME â€“ PROTON LOGIN ==== -->
  <section id="home" class="page-section active">
    <h2>HoÅŸgeldiniz</h2>
    <p>Bu hizmeti kullanmak iÃ§in <strong>Protonâ€¯Mail</strong> hesabÄ±nÄ±zla giriÅŸ yapmanÄ±z gerekir.</p>
    <button id="protonLoginBtn" class="btn btn-primary"><i class="fab fa-protonmail"></i> Protonâ€¯Mail ile GiriÅŸ</button>
    <div id="loginInfo" class="mt-3"></div>
  </section>

  <!-- ==== SCAN ==== -->
  <section id="scan" class="page-section">
    <h2>Dosya Tarama</h2>
    <div class="file-drop" id="dropZone">
      <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i><br>
      DosyalarÄ± sÃ¼rÃ¼kleyip bÄ±rakÄ±n veya tÄ±klayÄ±n
      <input type="file" id="fileInput" multiple class="d-none"
             accept=".pdf,.docx,.txt,.jpg,.png,.exe,.zip">
    </div>
    <div id="fileList" class="mt-3"></div>
    <button id="scanBtn" class="btn btn-success mt-3" disabled><i class="fas fa-search"></i> Tarama BaÅŸlat</button>
    <div id="resultArea" class="mt-4"></div>
  </section>

  <!-- ==== SETTINGS ==== -->
  <section id="settings" class="page-section">
    <h2>Ayarlar</h2>
    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="autoUploadSwitch" checked>
      <label class="form-check-label" for="autoUploadSwitch">Tarama sonuÃ§larÄ±nÄ± Protonâ€¯Driveâ€™a otomatik kaydet</label>
    </div>
    <button id="saveSettings" class="btn btn-primary">Kaydet</button>
  </section>
</div>

<!-- Toast -->
<div class="toast align-items-center text-bg-primary border-0" id="toastMsg">
  <div class="d-flex">
    <div class="toast-body" id="toastBody"></div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"></button>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"
        integrity="sha256-3gJwYp+Z5Y6V4J+L/2j8KJp2K5Z5+5R5j5J5U5V5U5U="
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+2V5x5x5x5x5x5x5x5x5x5x5x5x5x5x5"
        crossorigin="anonymous"></script>

<script>
/* --------------------------------------------------------------
   1. Tema (light / dark)
   -------------------------------------------------------------- */
document.getElementById('themeToggle').addEventListener('click',()=> {
  const cur=document.body.dataset.theme;
  document.body.dataset.theme = cur==='light'?'dark':'light';
});

/* --------------------------------------------------------------
   2. Sayfa GeÃ§iÅŸleri
   -------------------------------------------------------------- */
document.querySelectorAll('[data-page]').forEach(link=>{
  link.addEventListener('click',e=>{
    e.preventDefault();
    const target=e.target.dataset.page;
    document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
    document.getElementById(target).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    e.target.classList.add('active');
  });
});

/* --------------------------------------------------------------
   3. Proton OAuth â€“ Config
   -------------------------------------------------------------- */
// ðŸ‘‰ BU DEÄžERLERÄ° PROTON DEVELOPER CONSOLE'DAN ALIN
const PROTON_CLIENT_ID = 'YOUR_CLIENT_ID';                     // <-- deÄŸiÅŸtir
const PROTON_REDIRECT_URI = `${location.origin}/oauth/callback`; // GitHub Pages URL
const PROTON_AUTH_ENDPOINT = 'https://account.proton.me/oauth/v2/auth';
const PROTON_SCOPES = 'openid profile email drive';

/* Helper: gÃ¶sterim */
function showToast(msg,type='primary'){
  const toast=document.getElementById('toastMsg');
  const body=document.getElementById('toastBody');
  body.textContent=msg;
  toast.className=`toast align-items-center text-bg-${type} border-0`;
  new bootstrap.Toast(toast,{delay:4000}).show();
}

/* -----------------------------------------------------------------
   4. Login â€“ Popup â†’ Redirect â†’ Callback
   ----------------------------------------------------------------- */
document.getElementById('protonLoginBtn').addEventListener('click',()=>{
  const state = Math.random().toString(36).substring(2);
  sessionStorage.setItem('pkce_state',state);
  const authUrl = `${PROTON_AUTH_ENDPOINT}?client_id=${encodeURIComponent(PROTON_CLIENT_ID)}
    &redirect_uri=${encodeURIComponent(PROTON_REDIRECT_URI)}
    &response_type=code&scope=${encodeURIComponent(PROTON_SCOPES)}
    &state=${state}`;
  // Popup ile oturum aÃ§
  const w = window.open(authUrl,'protonLogin','width=500,height=600');
  const poll = setInterval(()=>{
    try{
      if(w.location.href.startsWith(PROTON_REDIRECT_URI)){
        clearInterval(poll);
        const url = new URL(w.location);
        const code = url.searchParams.get('code');
        const returnedState = url.searchParams.get('state');
        if(state!==returnedState){
          showToast('State mismatch â€“ gÃ¼venlik hatasÄ±', 'danger');
          w.close();return;
        }
        // Kod alÄ±ndÄ±, token almak iÃ§in proxyâ€™e POST
        fetch('/api/token', {               // <-- proxy endpoint
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({code, redirect_uri:PROTON_REDIRECT_URI})
        })
        .then(r=>r.json())
        .then(data=>{
          if(data.access_token){
            localStorage.setItem('proton_access_token',data.access_token);
            localStorage.setItem('proton_id_token',data.id_token);
            document.getElementById('loginInfo')
              .innerHTML = `<div class="alert alert-success mt-2">
                              GiriÅŸ baÅŸarÄ±lÄ±: ${data.email || 'bilinmiyor'}
                            </div>`;
            showToast('GiriÅŸ baÅŸarÄ±lÄ±, tarama sayfasÄ±na yÃ¶nlendiriliyorsunuz.');
            setTimeout(()=>document.querySelector('[data-page="scan"]').click(),1500);
          }else{
            showToast('Token alma baÅŸarÄ±sÄ±z', 'danger');
          }
        })
        .catch(()=>showToast('Proxy hatasÄ±', 'danger'));
        w.close();
      }
    }catch(e){ /* crossâ€‘origin hatasÄ± normalde oluÅŸur */ }
  },500);
});

/* -----------------------------------------------------------------
   5. Dosya SeÃ§imi / Dragâ€‘Drop
   ----------------------------------------------------------------- */
const dropZone=document.getElementById('dropZone');
const fileInput=document.getElementById('fileInput');
let selectedFiles=[];
dropZone.addEventListener('click',()=>fileInput.click());
dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('dragover');});
dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop',e=>{
  e.preventDefault();dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change',()=>handleFiles(fileInput.files));

function handleFiles(files){
  selectedFiles = [...files];
  const list=document.getElementById('fileList');
  list.innerHTML = selectedFiles.map(f=>`<div>${f.name} (${(f.size/1024).toFixed(1)}â€¯KB)</div>`).join('');
  document.getElementById('scanBtn').disabled = !selectedFiles.length;
}

/* -----------------------------------------------------------------
   6. VirÃ¼s Veri TabanÄ± (gÃ¶mÃ¼lÃ¼)
   ----------------------------------------------------------------- */
const virusDB = [
  {"id":"trojan-001","name":"FakeTrojan","hash":"a1b2c3d4e5f67890abcdef1234567890"},
  {"id":"ransomware-007","name":"CryptoLock","hash":"11223344556677889900aabbccddeeff"}
];

/* -----------------------------------------------------------------
   7. Tarama ve Driveâ€™a Upload
   ----------------------------------------------------------------- */
document.getElementById('scanBtn').addEventListener('click', async ()=>{
  const token = localStorage.getItem('proton_access_token');
  if(!token){showToast('Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z.', 'warning');return;}

  const resultDiv=document.getElementById('resultArea');
  resultDiv.innerHTML = '<p>Tarama yapÄ±lÄ±yorâ€¦</p>';

  const reports = [];
  for(const f of selectedFiles){
    const buf = await f.arrayBuffer();
    const hashBuf = await crypto.subtle.digest('SHA-256', buf);
    const hashHex = Array.from(new Uint8Array(hashBuf))
                         .map(b=>b.toString(16).padStart(2,'0')).join('');
    const match = virusDB.find(v=>v.hash===hashHex);
    const status = match ? `Tehlikeli (${match.name})` : 'GÃ¼venli';
    reports.push({file:f.name,hash:hashHex,status});
  }

  // SonuÃ§larÄ± ekrana bas
  let html = '<h4>Tarama SonuÃ§larÄ±</h4><ul class="list-group">';
  reports.forEach(r=>{
    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
               ${r.file}<span class="${r.status.startsWith('Tehlikeli')?'text-danger':'text-success'}">${r.status}</span>
             </li>`;
  });
  html += '</ul>';
  resultDiv.innerHTML = html;

  // Otomatik Drive upload (proxy Ã¼zerinden)
  if(document.getElementById('autoUploadSwitch').checked){
    uploadReportToDrive(reports, token);
  }
});

/* -----------------------------------------------------------------
   8. Proxyâ€‘Ãœzerinden Driveâ€™a Rapor GÃ¶nder
   ----------------------------------------------------------------- */
function uploadReportToDrive(report, accessToken){
  // Raporu JSON olarak paketle
  const payload = {
    name: `clean-master-report-${Date.now()}.json`,
    mimeType: 'application/json',
    content: JSON.stringify(report, null, 2)
  };
  fetch('/api/drive/upload', {               // <-- proxy endpoint
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${accessToken}`
    },
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.success){
      showToast('Rapor Protonâ€¯Driveâ€™a kaydedildi.');
    }else{
      showToast('Drive upload baÅŸarÄ±sÄ±z: '+(res.error||'unknown'), 'danger');
    }
  })
  .catch(()=>showToast('Proxy hatasÄ± (Drive upload)', 'danger'));
}

/* -----------------------------------------------------------------
   9. AyarlarÄ± Kaydet / YÃ¼kle (localStorage)
   ----------------------------------------------------------------- */
document.getElementById('saveSettings').addEventListener('click',()=>{
  const auto = document.getElementById('autoUploadSwitch').checked;
  localStorage.setItem('autoUpload',auto);
  showToast('Ayarlar kaydedildi.');
});
window.addEventListener('load',()=>{
  const auto = localStorage.getItem('autoUpload');
  if(auto!==null) document.getElementById('autoUploadSwitch').checked = (auto==='true');
});
</script>
</body>
</html>
